<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<title>commentJson</title>
<script src="../js/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function() {
		loadCommentList();
	});
	//json데이터를 호출하는 ajax.
	function loadCommentList() {
		$.ajax({
			url : '../CommentServlet',
			data : {
				cmd : 'selectJson'
			},
			success : loadCommentResult,
			error : function(reject) {
				consloe.log(reject);
			}
		});
	}
	//리스트콜백함수
	function loadCommentResult(resolve) {
		console.log(resolve)
		let aryData = resolve;
		for (let i = 0; i < aryData.length; i++) {
			let commentDiv = makeCommentView(aryData[i]);
			$('#commentList').append(commentDiv);
		}
	}
	// 오브젝트 한건을 매개값으로 받아 div로 반환해주는 함수
	function makeCommentView(comment) { //{id:?, name:?, content:?}
		let div = $('<div />').attr('id', comment.id);
		$(div).attr('data-id',comment.id)
		$(div).attr('data-name',comment.name)
		$(div).attr('data-content',comment.content)
		let strong = $('<strong />').html(comment.name);
		let span = $('<span />').html(comment.content)
		let upDateBtn = $('<input onclick="viewUpdataForm('+comment.id+')"/>').attr({
			'type' : 'button',
			'value' : '수정'
		});
		let deleteBtn = $('<input onclick="confirmDeletion('+comment.id+')"/>').attr({
			'type' : 'button',
			'value' : '삭제',
		});
		$(div).append(strong, span, upDateBtn, deleteBtn);

		return div;
	}
	//등록
	function addComment() {
		let name = document.addForm.name.value;
		let content = document.addForm.content.value;
		if (name == '') {
			alert('이름입력');
			document.addForm.name.focus();
			return;
		}
		if (content == '') {
			alert('내용입력');
			document.addForm.content.focus();
			return;
		}
		$.ajax({
			url : '../CommentServlet',
			data : {
				cmd : 'insertJson',
				name : name,
				content : content
			},
			//data: 'cmd=insertJson&name='+name+'content='+content
			success : addResult,
			error : function(reject) {
				console.log(reject)
			}
		});
	}
	//등록콜백함수
	function addResult(resolve) {//{id:?, name:?, content:?}
		let commentDiv = makeCommentView(resolve);
		$('#commentList').append(commentDiv);
		document.addForm.content.value = '';
		document.addForm.name.value = '';
		document.addForm.name.focus();
	}
	
	//수정버튼
	function viewUpdataForm(id){		
		console.log(id)
		let updateFormDiv = $('#commentUpdate');
		let commentDiv = $('#'+id);
		console.log(commentDiv);
		updateForm.id.value = $(commentDiv).attr('data-id');
		updateForm.name.value = $(commentDiv).attr('data-name');
		updateForm.content.value = $(commentDiv).attr('data-content');
		$(commentUpdate).css('display', 'block');
		$(commentDiv).after(updateFormDiv);
		$(addForm).css('display', 'none');
		
		}
	//DB,화면 변경	
	function updatecomment(){
		let id = updateForm.id.value;
		let name = updateForm.name.value;
		let content = updateForm.content.value;
		
		$.ajax({
			url: '../CommentServlet',
			data:{
				cmd: 'updateJson',
				id: id,
				name: name,
				content: content
			},
			success: updateResult,
			error : function(reject) {
				console.log(reject);
			}
			
		})
	}
	//수정콜백
	function updateResult(resolve){
		let commentDiv = makeCommentView(resolve);
		let oldDiv = $('#'+resolve.id);
		$(oldDiv).replaceWith(commentDiv);
		$(commentUpdate).css('display', 'none');
		$(addForm).css('display', 'block');
	}
	//취소
	function cancelUpdate() {
		$(commentUpdate).css('display', 'none');
		$(addForm).css('display', 'block');
	}
	//삭제버튼
	function confirmDeletion(id) {
		//let id = document.commentList.id.value;
		$.ajax({
			url : '../CommentServlet',
			data : {
				cmd: 'deleteJson',
				id: id
			},
			success : deleteResult,
			error : function(reject) {
				console.log(reject);
			}
		});
	}
	//삭제 콜백
	function deleteResult(resolve) {
		console.log(resolve);
		let del = $('#'+resolve.id);
		$(del).remove();
		window.alert('삭제완료');


	}
	
</script>
</head>

<body>
	<!-- 댓글목록 -->
	<div id='commentList'></div>
	<!-- 댓글등록화면 -->
	<div id='commentAdd'>
		<form name='addForm' action="">
			이름: <input type='text' name='name' size='10'><br> 내용:
			<textarea name='content' rows="3" cols="20"></textarea>
			<br> <input type='button' value='등록' onclick='addComment()'>
		</form>
	</div>
	<!-- 댓글수정화면 -->
	<div id='commentUpdate' style="display: none;">
		<form name='updateForm' action="">
			<input type='hidden' name='id'> 
			이름: <input type='text'name='name' size='10'><br> 
			내용: <textarea name='content' rows="3" cols="20"></textarea><br>
			 <input type='button' value='변경' onclick='updatecomment()'>
			<input type='button' value='취소' onclick='cancelUpdate()'>
		</form>
	</div>
</body>

</html>
<!-- html(화면) <-주고받고-> java(servlet, DAO) <-주고받고-> 데이터베이스 -->